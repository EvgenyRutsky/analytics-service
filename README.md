# analytics-service
Приложение, написанное на Go, которое принимает POST запросы, содержащие события с целочисленным значением. Также по GET запросу возвращает среднее значение
обработанных запросов за последнюю минуту.

Для нагрузки данного сервиса можно использовать клиент [analytics-client](https://github.com/EvgenyRutsky/analytics-client)

## Запуск
Дефолтный порт, используемый приложением - `:9090`

При запуске из CLI поддерживается передача приложению следующих атрибутов:
`-dbuser` -- имя пользователя базы данных
`-dbpass` -- пароль пользователя базы данных

Команда запуска сервиса используя исходный код (компиляция инструментами go) может выглядеть следующим образом:

`go run main.go -dbuser=default -dbpass=password`

`-help` отобразит информацию о поддерживаемых атрибутах. _Для запуска с дефолтными значениями, не используем атрибуты вовсе_

## Технические решения
- В качестве роутера входящих запросов используется библиотека `github.com/gorilla/mux`, которая существенно упрощает работу с роутингом входящих запросов
- ClickHouse используется в качестве базы данных для хранения входящих событий, потому что эта база специально была разработана для хранения аналитических данных и широко используется в подобных случаях. Плюсами данной базы являются: 
  - поддержка SQL синтаксиса (в большей степени)
  - хранения данных по колонкам, а не по строчкам, что обеспечивает быстрое чтение большого количества значений из одной колонки (так как не нужно вычитывать строчки целиком)
  - возможность развернуть базу в облаке
  - поддержка асинхронных вставок и вставок по колонкам
  
  Недостатками базы можно считать:
  - сравнительно медленная и не эффективная запись данных по одной строчке, так как таблица хранится по колонкам (колонка это отдельный файл)
  - ограниченный функционал по сравнению с другими SQL базами
  
  ClickHouse рекомендует использовать промежуточные таблицы для агрегирования данных и вставки батча значений за один INSERT, а так же использовать вставку по колонками где это возможно для ускорения записи в базу.
  В данном приложении используется асинхронная вставка строк, что позволяет отдать данные на сторону ClickHouse и делегировать управление особенностями вставки средствами внутренних ресурсов базы.
- В приложении используется база, развернутая в облаке ClickHouse, что увеличивает время отклика базы из-за коммуникации по HTTP, но упрощает разворачивание и доступ к базе из различных устройств
- Приложение выдерживает 50-60 RPS, причем узким местом является именно запись в базу данных. Выход на требуемые RPS был выполнен за счет использования асинхронных вставок и увеличения количества открытых соединений до 100
- Для передачи кред базы данных при старте сервиса было решено использовать флаги. Для более сложных конфигураций имеет смысл использовать переменные окружения и файлы конфигурации

## REST API
Приложение поддерживает 2 REST метода:
1. POST для передачи ивентов приложению. Тело запроса выглядит следующим образом:
`{"value":42}`.
`Timestamp` ивенту проставляется в момент получения этого ивента сервисом
2. GET для получения среднего значения ивентов, полученных за последнюю секунду. Ответ сервера выглядит следующим образом:
`{"rowsNumber":678,"avgValue":49}`
   - `rowsNumber` показывает количество ивентов, которые участвовали в рассчете среднего значения. _Если количество строк = 0, значит за последнюю минуту    ивентов не поступало и рассчет среднего значение не производился_
   - `avgValue` показывает среднее значение полученных ивентов за последние 60 секунд
   
 ## Вопросы
 1. Какой приблизительный диапазон числовых значений Value будут использоваться в ивентах? (для правильного выбора типа данных, на данный момент используется int)
 2. Регистрируем ли мы время события по факту поступления ивента или получаем в теле ивента? (на данный момент сервис проставляет вермя)
 3. Планируется ли расширение сервиса для обработки ивентов другого вида или назначения? Это влияет на архитектуру и дальнейший выбор технологий
 4. Как долго данные в базе остаются востребованными? С текущей заявленной нагрузкой, данные очень быстро поступают в базу и заполняют ее, а мы используем только данные за последнюю минуту. Возможно имеет смысл настроить политики утилизации ненужных данных или подумать над сжатием
 5. Будут ли входящие ивенты только в виде JSON?
 6. Планируется ли увеличения RPS?
 7. Нужна ли визуализация аналитических данных?
 




